# #047 「アトミック操作」

```javascript
// atomic-counter.mjs
import { Worker, isMainThread, workerData, parentPort } from 'node:worker_threads';
if (isMainThread) {
  const shared = new SharedArrayBuffer(4);
  const counter = new Int32Array(shared);
  for (let i = 0; i < 4; i += 1) {
    new Worker(new URL(import.meta.url), { workerData: shared });
  }
  setInterval(() => console.log(Atomics.load(counter, 0)), 100);
} else {
  const counter = new Int32Array(workerData);
  setInterval(() => Atomics.add(counter, 0, 1), 1);
}
```

```javascript
// cas-loop.mjs
const buffer = new SharedArrayBuffer(4);
const view = new Int32Array(buffer);
let prev;
do {
  prev = Atomics.load(view, 0);
} while (Atomics.compareExchange(view, 0, prev, prev + 1) !== prev);
```
