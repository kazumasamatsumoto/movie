# #046 「メモリバリア」

```javascript
// barrier.mjs
import { Worker, isMainThread, workerData, parentPort } from 'node:worker_threads';
if (isMainThread) {
  const shared = new SharedArrayBuffer(8);
  const view = new Int32Array(shared);
  const worker = new Worker(new URL(import.meta.url), { workerData: shared });
  worker.on('message', value => console.log(`worker observed: ${value}`));
  setInterval(() => {
    Atomics.store(view, 0, Math.trunc(Math.random() * 1000) + 1);
    Atomics.notify(view, 0);
  }, 100);
} else {
  const view = new Int32Array(workerData);
  while (true) {
    Atomics.wait(view, 0, 0);
    const value = Atomics.load(view, 0);
    parentPort?.postMessage(value);
    Atomics.store(view, 0, 0);
  }
}
```

```text
Atomics.store/load は必要なメモリバリアを挿入し、他スレッドが最新値を観測できるようにします。
```
