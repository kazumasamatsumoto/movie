# #049 「デッドロックとは」

```javascript
// deadlock.mjs
import { Worker, isMainThread, workerData } from 'node:worker_threads';
if (isMainThread) {
  const shared = new SharedArrayBuffer(8);
  const view = new Int32Array(shared);
  new Worker(new URL(import.meta.url), { workerData: { shared, id: 0, waitIndex: 1 } });
  new Worker(new URL(import.meta.url), { workerData: { shared, id: 1, waitIndex: 0 } });
} else {
  const { shared, id, waitIndex } = workerData;
  const view = new Int32Array(shared);
  console.log(`worker ${id} acquiring lock ${id}`);
  Atomics.store(view, id, 1);
  console.log(`worker ${id} waiting for lock ${waitIndex}`);
  while (Atomics.compareExchange(view, waitIndex, 0, 1) !== 0) {
    Atomics.wait(view, waitIndex, 1);
  }
}
```

```javascript
// ordered-lock.mjs
const locks = ['db', 'cache'];
locks.sort().forEach(lock => acquire(lock));
```

```text
資源取得の順序を統一するなどして循環待ちを回避しましょう。
```
