# #007 「v11新機能 - マイクロサービス強化」

四国めたん「v11ではマイクロサービスサポートも強化されています」
ずんだもん「高負荷環境を意識したアップデートなんだね」
四国めたん「NATSやKafkaドライバーでバッチ送信や並列処理の設定が細かくできるようになりました」
ずんだもん「メッセージの可観測性も向上したって聞いたよ」
四国めたん「シリアライザーとデシリアライザーの拡張ポイントも整理されています」
ずんだもん「独自プロトコルでも組み込みやすいんだね」
四国めたん「ヘルスチェック用のHybridアプリ構成もサポートが強化されました」
ずんだもん「マイクロサービス構成に自信を持って挑めるよ！」

---

## 📺 画面表示用コード

```typescript
// main.micro.ts
import { NestFactory } from '@nestjs/core';
import { MicroserviceOptions, Transport } from '@nestjs/microservices';
import { AppModule } from './app.module';

async function bootstrap() {
  const app = await NestFactory.createMicroservice<MicroserviceOptions>(AppModule, {
    transport: Transport.NATS,
    options: { servers: ['nats://localhost:4222'], maxReconnectAttempts: 5 },
  });
  await app.listen();
}
bootstrap();

// metrics.controller.ts
import { Controller } from '@nestjs/common';
import { MessagePattern, Payload } from '@nestjs/microservices';

@Controller()
export class MetricsController {
  @MessagePattern('metrics.ingest')
  handleMetric(@Payload() payload: Record<string, unknown>) {
    return { status: 'accepted', ...payload };
  }
}

// micro.config.ts
import { CustomTransportStrategy } from '@nestjs/microservices';

export const microOptions = {
  retryAttempts: 3,
  retryDelay: 500,
  strategy: new (class implements CustomTransportStrategy {
    listen() {
      /* connect to broker with v11 hooks */
    }
    close() {
      /* graceful shutdown */
    }
  })(),
};
```
